<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–ß–∞—Ç-–±–æ—Ç –¥–ª—è –ø—ñ–¥–±–æ—Ä—É –∫–æ–º–ø'—é—Ç–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á–∏—Ö">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <title>–ß–∞—Ç-–±–æ—Ç –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</title>

    <!-- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .chat-container {
            max-width: 1000px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header h2 {
            color: #fff;
            font-size: 2em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .chat-wrapper {
            position: relative;
            height: 600px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .messages-wrapper {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 60px;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
        }

        .typing-indicator {
            position: absolute;
            left: 20px;
            bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s ease;
        }

        .typing-indicator.visible {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .message {
            max-width: 80%;
            margin: 10px 0;
            padding: 15px;
            border-radius: 15px;
            animation: fadeIn 0.5s ease-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .message.user {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.bot {
            background: #f5f5f5;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .chat-input-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chat-input {
            border: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 25px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 0 3px rgba(13, 110, 253, 0.25);
        }

        .btn-send {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #007bff;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header animate__animated animate__fadeInDown">
            <h2>üíª –ß–∞—Ç-–±–æ—Ç –¥–ª—è –∫–æ–º–ø'—é—Ç–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–ª–µ–∫—Ç—É—é—á–∏—Ö</h2>
        </div>
        <div class="chat-wrapper">
            <div class="messages-wrapper">
                <div id="chat-messages" class="chat-messages"></div>
            </div>
            <div id="typing-indicator" class="typing-indicator hidden">
                <div class="typing-animation">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
                <span>–ë–æ—Ç –¥—Ä—É–∫—É—î...</span>
            </div>
        </div>
        <div class="chat-input-container animate__animated animate__fadeInUp">
            <form id="chat-form" class="d-flex gap-2">
                <input type="text" id="message" class="form-control chat-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." required>
                <button type="submit" class="btn btn-send">
                    –ù–∞–¥—ñ—Å–ª–∞—Ç–∏
                </button>
            </form>
        </div>
    </div>
    
    <!-- jQuery first, then Bootstrap Bundle with Popper -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID —Å–µ—Å—Å–∏–∏
        function generateSessionId() {
            return 'session_' + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }
        
        // –ü–æ–ª—É—á–∞–µ–º session_id –∏–∑ cookie –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        let sessionId = document.cookie.split('; ').find(row => row.startsWith('session_id='));
        sessionId = sessionId ? sessionId.split('=')[1] : generateSessionId();

        $('#chat-form').on('submit', function(e) {
            e.preventDefault();
            var userMessage = $('#message').val().trim();
            if(userMessage === '') return;
            
            // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            appendMessage('user', '<strong>–í–∏:</strong> ' + userMessage);
            $('#message').val('');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
            const requestStartTime = Date.now();
            toggleTyping(true);

            // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É –¥–æ –±–µ–∫–µ–Ω–¥—É –∑ ID —Å–µ—Å—Å–∏–∏
            $.ajax({
                url: '/ask',
                method: 'POST',
                data: { 
                    message: userMessage,
                    session_id: sessionId
                },
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-Session-ID', sessionId);
                },
                success: function(data) {
                    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (500ms)
                    const minTypingTime = 500;
                    const elapsed = Date.now() - requestStartTime;
                    
                    if (elapsed < minTypingTime) {
                        // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –∂–¥–µ–º
                        setTimeout(() => {
                            toggleTyping(false);
                            appendMessage('bot', '<strong>–ë–æ—Ç:</strong> ' + data.response);
                        }, minTypingTime - elapsed);
                    } else {
                        // –ò–Ω–∞—á–µ —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
                        toggleTyping(false);
                        appendMessage('bot', '<strong>–ë–æ—Ç:</strong> ' + data.response);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º session_id –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
                    if (data.session_id) {
                        sessionId = data.session_id;
                        document.cookie = `session_id=${sessionId};path=/;max-age=86400`;
                    }
                },
                error: function() {
                    toggleTyping(false);
                    appendMessage('bot', '<strong>–ë–æ—Ç:</strong> –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–∞–ø–∏—Ç—É');
                }
            });
        });

        // –§—É–Ω–∫—Ü—ñ—è –∞–≤—Ç–æ—Å–∫—Ä–æ–ª—É
        function smoothScrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä—É
        function toggleTyping(show) {
            const indicator = document.getElementById('typing-indicator');
            if (show) {
                indicator.classList.remove('hidden');
                indicator.classList.add('visible');
            } else {
                indicator.classList.remove('visible');
                indicator.classList.add('hidden');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function sendMessage() {
            // ...existing code...
            toggleTyping(true);  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            
            try {
                const response = await fetch('/ask', {
                    // ...existing code...
                });
                
                // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ ...
                
                toggleTyping(false);  // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                smoothScrollToBottom();  // –°–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–æ–≤–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            } catch (error) {
                toggleTyping(false);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
        function appendMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type} animate__animated animate__fadeInUp`;
            messageDiv.innerHTML = content;
            document.getElementById('chat-messages').appendChild(messageDiv);
            smoothScrollToBottom();
        }
    </script>
</body>
</html>
